<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>GM Digital Management</title>

    <!-- Bootstrap -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Tus estilos -->
    <link rel="stylesheet" th:href="@{/css/monitoring.css}">
    <link rel="stylesheet" th:href="@{/css/estilos.css}">

    <style>
        :root {
            --gm-blue: #11365f;
            --gm-light-blue: #e8eef9;
            --gm-dark: #1b1b1b;
            --gm-red: #e63946;
        }

        body, html, * {
            font-family: 'Overpass', sans-serif !important;
        }

        /* HEADER FIJO */
        .gm-header-fixed {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            z-index: 99999 !important;
        }

        /* ESPACIO PARA QUE EL HEADER NO TAPE EL CONTENIDO */
        .body-offset {
            padding-top: 95px !important;
        }


        h6 {
            color: var(--gm-blue);
        }

        .table-gm thead {
            background-color: var(--gm-light-blue) !important;
            color: var(--gm-dark);
            border-bottom: 1px solid var(--gm-blue);
        }

        .table-gm td, .table-gm th {
            border-color: #dcdcdc;
        }

        .modal-header {
            background-color: var(--gm-blue);
            color: white;
        }

        .section-title {
            color: var(--gm-blue);
            font-weight: bold;
            border-left: 4px solid var(--gm-blue);
            padding-left: 8px;
            margin-top: 20px;
        }

        /* ======= MODAL ERROR STYLE ======= */

        #errorModal .modal-content {
            border-radius: 18px;
            padding: 30px 25px;
            text-align: center;
        }

        #errorModal .error-icon {
            font-size: 70px;
            color: var(--gm-red);
        }

        #errorModal h4 {
            font-weight: 700;
            margin-top: 15px;
        }

        #errorModal p {
            font-size: 1.1rem;
            margin-top: 10px;
        }

        #errorModal button {
            margin-top: 10px;
            font-size: 1.1rem;
            padding: 10px 30px;
            border-radius: 30px;
        }
    </style>
</head>

<body class="body-offset">

<!-- NAVBAR -->
<div th:replace="fragments/header :: navbar" class="gm-header-fixed"></div>

<div class="container mt-5">
    <h3 class="mb-3">MONITORING</h3>

    <div class="card shadow-sm">
        <div class="card-body">

            <!-- ==================== TABS ==================== -->
            <ul class="nav nav-tabs" id="monitoringTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab"
                            data-bs-target="#pendingTab" type="button" role="tab">
                        New Requests
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                            data-bs-target="#historyTab" type="button" role="tab">
                        History
                    </button>
                </li>
            </ul>

            <div class="tab-content p-3 border border-top-0 rounded-bottom bg-white">

                <!-- =====================================
                        TAB: PENDIENTES
                ====================================== -->
                <div class="tab-pane fade show active" id="pendingTab" role="tabpanel">

                    <table class="table table-bordered table-gm align-middle text-center"
                           th:if="${requests != null and !requests.isEmpty()}">

                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Action</th>
                            <th>Attribute</th>
                            <th>User Request</th>
                            <th>Created</th>
                            <th>Details</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="v : ${requests}">
                            <td th:text="${v.id}"></td>
                            <td th:text="${v.action}"></td>
                            <td th:text="${v.attribute}"></td>
                            <td th:text="${v.userRequest.nomUser}"></td>
                            <td th:text="${#temporals.format(v.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                            <td>
                                <button class="btn btn-search btn-sm px-4"
                                        th:attr="onclick=|openModal(${v.id})|">
                                    View
                                </button>
                            </td>
                        </tr>
                        </tbody>

                    </table>

                    <div th:if="${requests == null || requests.isEmpty()}"
                         class="alert alert-info text-center p-4 mt-3">
                        No pending approvals
                    </div>
                </div>

                <!-- =====================================
                         TAB: HISTORIAL
                ====================================== -->
                <div class="tab-pane fade" id="historyTab" role="tabpanel">

                    <div th:if="${history == null or history.isEmpty()}"
                         class="alert alert-secondary text-center p-4">
                        No hay historial disponible
                    </div>

                    <table class="table table-bordered table-gm align-middle text-center"
                           th:if="${history != null and !history.isEmpty()}">

                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Action</th>
                            <th>Attribute</th>
                            <th>User Request</th>
                            <th>Approved By</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="h : ${history}">
                            <td th:text="${h.id}"></td>
                            <td th:text="${h.action}"></td>
                            <td th:text="${h.attribute}"></td>
                            <td th:text="${h.userRequest.nomUser}"></td>

                            <!-- QUIÉN APROBÓ -->
                            <td th:text="${h.userApprover != null ? h.userApprover.nomUser : '—'}"></td>

                            <td th:text="${#temporals.format(h.approvalDate, 'dd/MM/yyyy HH:mm')}"></td>
                            <td th:text="${h.status}"></td>

                            <td>
                                <button class="btn btn-search btn-sm px-4"
                                        th:attr="onclick=|openModalReadOnly(${h.id})|">
                                    View
                                </button>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL DE DETALLES ================= -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Validation Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- GENERAL INFO -->
                <h6 class="section-title">General Information</h6>

                <table class="table table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Action</th>
                        <th>Attribute</th>
                        <th>User Request</th>
                        <th>Date Request</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="modalId"></td>
                        <td id="modalAction"></td>
                        <td id="modalAttribute"></td>
                        <td id="modalUser"></td>
                        <td id="modalCreated"></td>
                    </tr>
                    </tbody>
                </table>

                <!-- VEHICLE INFO -->
                <h6 class="section-title">Vehicle Information</h6>

                <table class="table table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Year</th>
                        <th>Brand</th>
                        <th>Region</th>
                        <th>Model</th>
                        <th>Type</th>
                        <th>PDF English</th>
                        <th>PDF Spanish</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td id="vehName"></td>
                        <td id="vehYear"></td>
                        <td id="vehBrand"></td>
                        <td id="vehRegion"></td>
                        <td id="vehModel"></td>
                        <td id="vehType"></td>
                        <td id="vehPdfEng"></td>
                        <td id="vehPdfSpa"></td>
                    </tr>
                    </tbody>
                </table>

                <!-- CHANGES -->
                <h6 class="section-title">Changes</h6>
                <table class="table table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>Field</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Preview</th>
                    </tr>
                    </thead>
                    <tbody id="changesTable"></tbody>
                </table>

                <!-- PDF PREVIEW -->
                <div id="pdfContainer" style="display:none;">
                    <h6 class="section-title">PDF Preview</h6>

                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <button class="nav-link active"
                                    id="before-tab" data-bs-toggle="tab"
                                    data-bs-target="#beforePdfPanel">
                                Before PDF
                            </button>
                        </li>

                        <li class="nav-item">
                            <button class="nav-link"
                                    id="after-tab" data-bs-toggle="tab"
                                    data-bs-target="#afterPdfPanel">
                                After PDF
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content border p-2">
                        <div class="tab-pane fade show active" id="beforePdfPanel">
                            <iframe id="pdfBeforeFrame"
                                    style="width:100%; height:500px;"></iframe>
                        </div>

                        <div class="tab-pane fade" id="afterPdfPanel">
                            <iframe id="pdfAfterFrame"
                                    style="width:100%; height:500px;"></iframe>
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-search" id="btnReject">Reject</button>
                <button class="btn btn-search" id="btnApprove">Approve</button>
                <button class="btn btn-search" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<!-- ==================== MODAL DE ERROR ==================== -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="error-icon">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>

            <h4>Error</h4>

            <p id="errorMessage">You cannot complete this action.</p>

            <button class="btn btn-secondary" data-bs-dismiss="modal">CLOSE</button>

        </div>
    </div>
</div>

<div class="mt-5"></div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

    function openModalReadOnly(id) {
        openModal(id, true);
    }

    function cleanPdfName(name) {
        if (!name) return null;
        let n = name.replace(/"/g, "").trim();
        return n.toLowerCase().endsWith(".pdf") ? n : null;
    }

    function isEmptyPdf(x) {
        return !x || x === "null" || x === "undefined";
    }

    function openModal(id, readOnly = false) {

        fetch('/monitoring/details/' + id)
            .then(r => r.json())
            .then(data => {

                modalId.textContent = data.id;
                modalAction.textContent = data.action;
                modalAttribute.textContent = data.attribute;
                modalUser.textContent = data.user;
                modalCreated.textContent = data.created.replace("T", " ");

                if (data.vehicle) {
                    vehName.textContent = data.vehicle.name;
                    vehYear.textContent = data.vehicle.year;
                    vehBrand.textContent = data.vehicle.relation.brand;
                    vehRegion.textContent = data.vehicle.relation.region;
                    vehModel.textContent = data.vehicle.relation.model;
                    vehType.textContent = data.vehicle.relation.type;
                    vehPdfEng.textContent = data.vehicle.fileEng;
                    vehPdfSpa.textContent = data.vehicle.fileSpa;
                }

                const table = document.getElementById("changesTable");
                table.innerHTML = "";

                let beforePdf = null;
                let afterPdf = null;

                data.changes.forEach(c => {
                    let isPdf = (c.field === "fileNameEng" || c.field === "fileNameSpa");

                    if (isPdf) {
                        beforePdf = cleanPdfName(c.before);
                        afterPdf = cleanPdfName(c.after);
                    }

                    table.insertAdjacentHTML("beforeend", `
                        <tr>
                            <td><strong>${c.field}</strong></td>
                            <td>${c.before}</td>
                            <td>${c.after}</td>
                            <td>
                                ${isPdf ? `
                                    <button class="btn btn-search btn-sm" onclick="showBeforePdf('${beforePdf}')">Before</button>
                                    <button class="btn btn-search btn-sm" onclick="showAfterPdf('${afterPdf}')">After</button>
                                ` : "—"}
                            </td>
                        </tr>
                    `);
                });

                const pdfContainer = document.getElementById("pdfContainer");

                if (!isEmptyPdf(beforePdf) || !isEmptyPdf(afterPdf)) {
                    pdfContainer.style.display = "block";
                } else {
                    pdfContainer.style.display = "none";
                }

                if (!isEmptyPdf(beforePdf))
                    pdfBeforeFrame.src = window.location.origin + "/pdfs/" + beforePdf;

                if (!isEmptyPdf(afterPdf))
                    pdfAfterFrame.src = window.location.origin + "/pdfs/" + afterPdf;

                if (readOnly) {
                    btnApprove.style.display = "none";
                    btnReject.style.display = "none";
                } else {
                    btnApprove.style.display = "inline-block";
                    btnReject.style.display = "inline-block";
                }

                btnApprove.onclick = () => approve(id);
                btnReject.onclick = () => reject(id);

                new bootstrap.Modal(document.getElementById("detailsModal")).show();
            });
    }

    function showBeforePdf(name) {
        if (isEmptyPdf(name)) return;
        pdfBeforeFrame.src = window.location.origin + "/pdfs/" + name;
        new bootstrap.Tab(document.getElementById("before-tab")).show();
    }

    function showAfterPdf(name) {
        if (isEmptyPdf(name)) return;
        pdfAfterFrame.src = window.location.origin + "/pdfs/" + name;
        new bootstrap.Tab(document.getElementById("after-tab")).show();
    }

    // ===================================================
    //           FUNCIONES APROBAR / RECHAZAR
    // ===================================================
    function approve(id) {
        fetch('/monitoring/approve/' + id, { method: 'POST' })
            .then(r => r.text())
            .then(res => {

                if (res === "OK") {
                    location.reload();
                    return;
                }

                let msg = "This user doesn’t have sufficient permissions to complete this action.";

                if (res.includes("You cannot approve your own request")) {
                    msg = "You cannot approve your own request. Another user must approve it.";
                }

                showError(msg);
            });
    }

    function reject(id) {
        fetch('/monitoring/reject/' + id, { method: 'POST' })
            .then(r => r.text())
            .then(res => {

                if (res === "OK") {
                    location.reload();
                    return;
                }

                let msg = "This user doesn’t have sufficient permissions to complete this action.";

                if (res.includes("You cannot approve your own request")) {
                    msg = "You cannot reject your own request. Another user must reject it.";
                }

                showError(msg);
            });
    }

    // ===================================================
    //                  MOSTRAR MODAL ERROR
    // ===================================================
    function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        new bootstrap.Modal(document.getElementById("errorModal")).show();
    }

</script>

</body>
</html>
