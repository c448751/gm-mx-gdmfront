<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>GM Digital Management</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <link rel="stylesheet" th:href="@{/css/estilos.css}">

    <!-- ========= ESTILOS PARA HEADER FIJO ========= -->
    <style>
        body {
            background-color: #edf4f9;
            font-family: 'Overpass', sans-serif !important;
        }

        /* HEADER FIJO */
        .gm-header-fixed {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            z-index: 99999 !important;
        }

        /* ESPACIO PARA QUE EL HEADER NO TAPE EL CONTENIDO */
        .body-offset {
            padding-top: 95px !important;
        }

        .icon-btn img {
            width: 26px;
            height: 26px;
            cursor: pointer;
            transition: 0.2s;
        }

        .icon-btn img:hover {
            opacity: 0.7;
        }
    </style>
</head>

<body class="body-offset">

<!-- Header -->
<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container mt-5">

    <h4 class="mb-3">EDIT VEHICLE</h4>

    <!-- ========================== -->
    <!-- FORM PRINCIPAL            -->
    <!-- ========================== -->
    <form th:action="@{/edit/save}" th:object="${vehicle}" method="post" enctype="multipart/form-data">

        <input type="hidden" th:field="*{idVehicle}"/>

        <!-- READ ONLY -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">

                <h5 class="mb-4">General Information</h5>

                <div class="row">

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Division</label>
                        <input type="text" class="form-control"
                               th:value="${vehicle.relation.brandRegionRelation.region.nameRegion}" disabled>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Brand</label>
                        <input type="text" class="form-control"
                               th:value="${vehicle.relation.brandRegionRelation.brand.nameBrand}" disabled>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Vehicle Type</label>
                        <input type="text" class="form-control"
                               th:value="${vehicle.relation.type.typeName}" disabled>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Model</label>
                        <input type="text" class="form-control"
                               th:value="${vehicle.relation.model.modelName}" disabled>
                    </div>

                </div>

            </div>
        </div>

        <!-- EDITABLE -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">

                <h5 class="mb-4">Specifications & Manuals</h5>

                <!-- NAME -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Vehicle Name</label>
                    <input type="text" class="form-control" th:field="*{nameVehicle}">
                </div>

                <!-- YEAR -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Year</label>
                    <input type="number" class="form-control" th:field="*{year}">
                </div>

                <!-- PDF English -->
                <label class="form-label fw-semibold">English Manual</label>
                <div class="d-flex align-items-center gap-3 p-3 border rounded bg-light mb-4">

                    <input type="file" name="fileEng" class="form-control" lang="en"/>

                    <span th:if="${vehicle.fileNameEng != null}" class="text-primary  h6 p-2">
                        <span th:text=" ${vehicle.fileNameEng} "></span>
                    </span>

                    <div th:if="${vehicle.fileNameEng != null}" class="d-flex gap-2  ">

                        <button type="button"
                                class="icon-btn btn btn-light"
                                th:attr="data-pdf-url=@{'/pdf/' + ${vehicle.fileNameEng}}"
                                onclick="openPdfFromButton(this)">
                            <img th:src="@{/images/view.png}" alt="View PDF">
                        </button>

                        <a th:href="@{'/pdf/' + ${vehicle.fileNameEng}}" download class="icon-btn btn btn-light">
                            <img th:src="@{/images/download.png}" alt="Download PDF">
                        </a>

                    </div>

                </div>

                <!-- PDF Spanish -->
                <label class="form-label fw-semibold">Spanish Manual</label>
                <div class="d-flex align-items-center gap-3 p-3 border rounded bg-light mb-4">

                    <input type="file" name="fileSpa" class="form-control" lang="en"/>

                    <span th:if="${vehicle.fileNameSpa != null}" class="text-primary h6 p-2">
                        <span th:text="${vehicle.fileNameSpa}"></span>
                    </span>

                    <div th:if="${vehicle.fileNameSpa != null}" class="d-flex gap-2">

                        <button type="button"
                                class="icon-btn btn btn-light"
                                th:attr="data-pdf-url=@{'/pdf/' + ${vehicle.fileNameSpa}}"
                                onclick="openPdfFromButton(this)">
                            <img th:src="@{/images/view.png}" alt="View PDF">
                        </button>

                        <a th:href="@{'/pdf/' + ${vehicle.fileNameSpa}}" download class="icon-btn btn btn-light">
                            <img th:src="@{/images/download.png}" alt="Download PDF">
                        </a>

                    </div>

                </div>

            </div>
        </div>

        <!-- BOTONES -->
        <div class="d-flex justify-content-end gap-3 mb-5">
            <a href="/" class="btn btn-search px-4">Cancel</a>
            <button type="submit" class="btn btn-search px-4">Save</button>
        </div>

    </form>

</div>

<!-- =============================== -->
<!--       MODAL: PDF VIEWER        -->
<!-- =============================== -->
<div class="modal fade" id="pdfModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">View PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="height: 80vh;">
                <iframe id="pdfViewer"
                        src=""
                        width="100%"
                        height="100%"
                        style="border:none;">
                </iframe>
            </div>

        </div>
    </div>
</div>

<!-- =============================== -->
<!--    MODAL: REQUEST SUBMITTED     -->
<!-- =============================== -->
<div class="modal fade" id="modalSuccess" tabindex="-1" th:if="${requestSubmitted}">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">

            <div style="font-size:50px; color:#ffcc00;">⚠️</div>

            <h4 class="mt-3">Request submitted for approval</h4>
            <p>Awaiting approval from an authorized user.</p>

            <button class="btn btn-search" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<!-- =============================== -->
<!--      MODAL: NO CHANGES         -->
<!-- =============================== -->
<div class="modal fade" id="modalNoChanges" tabindex="-1" th:if="${noChanges}">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">

            <div style="font-size:50px; color:red;">❗</div>

            <h4 class="mt-3">No changes detected</h4>
            <p>You must modify at least one field before submitting.</p>

            <button class="btn btn-search" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<!-- =============================== -->
<!--  MODAL: YA EXISTE UNA SOLICITUD -->
<!-- =============================== -->
<div class="modal fade" id="modalPending" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">

            <div style="font-size:50px; color:#ffcc00;">⚠️</div>

            <h4 class="mt-3">A pending request already exists</h4>
            <p>You must wait until the existing request is approved or rejected.</p>

            <button class="btn btn-search" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function openPdfModal(pdfUrl) {
        document.getElementById("pdfViewer").src = pdfUrl;
        new bootstrap.Modal(document.getElementById('pdfModal')).show();
    }

    function openPdfFromButton(btn) {
        let url = btn.getAttribute("data-pdf-url");
        openPdfModal(url);
    }

    // ===========================
    //       SHOW MODALS
    // ===========================
    document.addEventListener("DOMContentLoaded", function () {

        if ("[[${requestSubmitted}]]" === "true") {
            new bootstrap.Modal(document.getElementById("modalSuccess")).show();
        }

        if ("[[${noChanges}]]" === "true") {
            new bootstrap.Modal(document.getElementById("modalNoChanges")).show();
        }
    });

    // ===========================
    //  REDIRECT ONLY ON SUCCESS
    // ===========================
    document.addEventListener("DOMContentLoaded", function () {

        const modalSuccess = document.getElementById("modalSuccess");

        if (modalSuccess) {
            modalSuccess.addEventListener("hidden.bs.modal", function () {
                window.location.href = "/";
            });
        }
    });

    document.addEventListener("DOMContentLoaded", function () {

        if ("[[${pendingRequest}]]" === "true") {
            new bootstrap.Modal(document.getElementById("modalPending")).show();
        }
    });
</script>

</body>
</html>
